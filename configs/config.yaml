# ==============================================================================
# CALIFORNIA HOUSING PIPELINE CONFIGURATION
# ==============================================================================
# This file controls the behavior of the training and prediction pipelines.
# It is validated strictly against schemas in `src/california_housing/core/config_definitions.py`.
# ==============================================================================

globals:
  target_col: "median_house_value"
  random_state: 42
  artifacts:
    root_dir: "artifacts"
    model_dir: "models"
    metrics_dir: "metrics"
  mlflow:
    experiment_name: "California Housing - test"
    registered_model_prefix: "california_housing"
  telemetry:
    autolog_enabled: true
    autolog_log_models: false
    autolog_silent: true

data_ingestion:
  type: "sqlite"
  db_path: "data/raw/housing.db"
  table_name: "housing"

data_preparation:
  cleaning:
    target_value_cap: 500001
  preprocessing:
    # Stratification Logic: Ensures train/test split preserves income distribution
    new_stratify_col: "income_cat"
    stratify_on_col: "median_income"
    stratify_bins: [0.0, 1.5, 3.0, 4.5, 6.0, .inf]
    stratify_labels: [1, 2, 3, 4, 5]
    min_stratify_samples: 3
  split:
    test_size: 0.2

model_trainer:
  # ---------------------------------------------------------------------------
  # Validation Strategy
  # Options: "single_split" (Fast) OR "cross_validation" (Robust)
  # ---------------------------------------------------------------------------
  validation_strategy: "single_split"

  single_split_config:
    val_size: 0.25  # 25% of training data used for validation

  cross_validation_config:
    n_folds: 5      # Standard K-Fold

  evaluation:
    metrics: ["rmse", "mae", "r2", "mse"] 
    metrics_filename: "{model_name}_metrics.json"

  preprocessing:
    # Feature Engineering
    ratio_cols:
      bedroom_ratio: ["total_bedrooms", "total_rooms"]
      rooms_per_house: ["total_rooms", "households"]
      people_per_house: ["population", "households"]
    log_cols:
      - "total_bedrooms"
      - "total_rooms"
      - "population"
      - "households"
      - "median_income"
    geo_cols:
      - "longitude"
      - "latitude"

    # Geographic Clustering (KMeans)
    n_clusters: 10
    gamma: 1.0

    # Imputation Strategies
    imputer_strategy_num: "median"        # Options: mean, median, most_frequent
    imputer_strategy_cat: "most_frequent" # Options: most_frequent, constant
    onehot_handle_unknown: "ignore"       # Options: error, ignore

    category_merging:
      col: "ocean_proximity"
      mapping:
        "ISLAND": "NEAR OCEAN"

    final_cleanup: 
      imputer_strategy: "median"
      perform_imputation: true
      handle_inf: true  # Converts Infinity to NaN before final imputation

  # Quality Gate: If Validation RMSE > 60,000, pipeline crashes intentionally.
  quality_threshold: 60000.0 

  # ---------------------------------------------------------------------------
  # Model Hyperparameters
  # Note: The 'type' field MUST match the key name.
  # ---------------------------------------------------------------------------
  params:
    LGBMRegressor:
      type: "LGBMRegressor"
      colsample_bytree: 0.7433862914177091
      learning_rate: 0.013057771348997228
      max_depth: 11
      min_child_samples: 18
      n_estimators: 1000
      num_leaves: 91
      objective: "regression"
      reg_alpha: 0.4494506741382034
      reg_lambda: 0.09541011649041131
      subsample: 0.7483273008793065
      verbose: -1
    RandomForestRegressor:
      type: "RandomForestRegressor"
      bootstrap: True
      max_depth: 40
      max_features: "sqrt"
      min_samples_leaf: 1
      min_samples_split: 4
      n_estimators: 200
    XGBRegressor:
      type: "XGBRegressor"
      colsample_bytree: 0.7693605922825478
      gamma: 0.19744075908778486
      learning_rate: 0.019655684599424853
      max_depth: 9
      min_child_weight: 3
      n_estimators: 1188
      objective: "reg:squarederror"
      subsample: 0.8827429375390468
      verbosity: 0 
      
model_registry:
  enabled: true
  target_alias: "staging"
  
prediction:
  default_model_name: "XGBRegressor"
  model_filename: "{model_name}_pipeline.pkl"
  artifacts:
    root_dir: "artifacts"
    model_dir: "models"
    metrics_dir: "metrics"
  mlflow:
    experiment_name: "California Housing - Production"
    registered_model_prefix: "california_housing"